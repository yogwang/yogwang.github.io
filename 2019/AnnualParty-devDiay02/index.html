<!DOCTYPE html>
<html lang="zh">
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  
  <title>年会开发日记02 - 红包雨 | blog [ YOG WANG ]</title>
  <meta name="keywords" content="YogWang,blog,web-frontend">
  <meta name="description" content="Here is my blog, my notes and some thoughts">
  <meta name="author" content="YogWang">
  <meta name="google-site-verification" content="C6xTGgRjDkU2yb8izJ39IyLjwUMbDpXiATd2a-WLg5U">
  
  <link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header id="header">
  <a class="header-sign" href="/">
    <img src="/favicon.png" alt="sign" />
    <span>YOG<br />WANG</span>
  </a>
  <nav class="header-navbar">
    
    <a class="nav-link" href="/archives">文章</a>
    
    <a class="nav-link" href="/about">我</a>
    
    <a class="nav-link" href="https://github.com/yogwang">GitHub</a>
    
  </nav>
</header>

    <div id="wrap">
      <main id="container">
  <div
  id="post-AnnualParty-devDiay02"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
>
  <div class="article-inner">
    <div class="article-meta">
      <p class="article-date">
  <time datetime="2019-12-17T13:12:50.000Z" itemprop="datePublished">2019-12-17</time>
</p> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/笔记/">笔记</a>
  </div>

    </div>
    
    <header class="article-header">
      
  
    <h1 class="article-title" itemprop="name">
      年会开发日记02 - 红包雨
    </h1>
  

    </header>
    
    <div class="article-entry" itemprop="articleBody">
       
  <article class="article-content">
    <blockquote>
<p>鸽了6个月了，终于想起来这篇还没有写完…</p>
</blockquote>
<p>年会预备了一个红包雨的活动，虽然到最后也没有用上，但是笔记还是要写的。<br>整个流程是关注公众号，然后回复 <code>抢红包</code> 返回一个授权地址获取用户授权信息，然后跳转到活动h5页面，抢红包的同时会在大荧幕上实时展示排名数据。</p>
<a id="more"></a>

<h2 id="📱-先说说手机端部分"><a href="#📱-先说说手机端部分" class="headerlink" title="📱 先说说手机端部分"></a>📱 先说说手机端部分</h2><p><img src="https://yogwang.site/2019/AnnualParty-devDiay02/mobile.jpg" alt="手机端截图"></p>
<p>手机端的部分其实很简单，从url上边获取用户的 <code>openID</code>,然后请求接口返回用户信息，这个时候也会返回活动是否开始的状态</p>
<ul>
<li>活动并没有开始，那么就进入手动进入的页面，用户手动点击按钮进入 <code>活动入口页</code>；</li>
<li>活动已经开始则直接进入 <code>预开始页</code>；</li>
<li>缺失openID，提示授权失败返回授权页面重新获取授权。</li>
</ul>
<p>参与用等待大荧幕指令，在大银幕倒数时就可以点击开始按钮进入同步的倒计时页面，同时会请求后端数据，这个时候后端会返回给我该用户被分配到的金额（哈，你没看错，后台已经按照设置的总金额给每个用户分配好了红包金额），然后按照分配到的金额数来判断是否会刷出 <code>188</code>、<code>88</code> 等大红包，怕用户错过这个大红包还做了特殊的样式（金色红包），剩下的金额则按照设置的持续时间数来生成具体的红包雨，一般来说会在收到数据的同时生成完红包雨数据，倒计时结束之后就开始下落。</p>
<h5 id="生成红包金额代码片段"><a href="#生成红包金额代码片段" class="headerlink" title="生成红包金额代码片段"></a>生成红包金额代码片段</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 红包金额分配</span></span><br><span class="line">rainBuild() &#123;</span><br><span class="line">  <span class="keyword">let</span> total = <span class="keyword">this</span>.info.amount; <span class="comment">// 总金额</span></span><br><span class="line">  <span class="keyword">let</span> lucky = []; <span class="comment">// 红包雨数组</span></span><br><span class="line">  <span class="comment">// 分配188红包</span></span><br><span class="line">  <span class="keyword">if</span> (total &gt; <span class="number">18800</span>) &#123;</span><br><span class="line">    total -= <span class="number">18800</span>;</span><br><span class="line">    lucky.push(&#123; <span class="attr">amount</span>: <span class="number">18800</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 分配88红包</span></span><br><span class="line">  <span class="keyword">if</span> (total &gt; <span class="number">8800</span>) &#123;</span><br><span class="line">    total -= <span class="number">8800</span>;</span><br><span class="line">    lucky.push(&#123; <span class="attr">amount</span>: <span class="number">8800</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> timer = <span class="number">10</span>; <span class="comment">// 拆分成10组</span></span><br><span class="line">  <span class="keyword">let</span> data = []; <span class="comment">// 临时红包数据</span></span><br><span class="line">  <span class="comment">// 红包雨数量限制</span></span><br><span class="line">  <span class="keyword">const</span> length = <span class="built_in">Math</span>.max(</span><br><span class="line">    <span class="built_in">Math</span>.ceil(((<span class="keyword">this</span>.info.duration / <span class="number">1000</span>) * <span class="number">4</span>) / timer),</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 平均每组金额</span></span><br><span class="line">  <span class="keyword">const</span> amount = total / timer;</span><br><span class="line">  <span class="comment">// 循环生成每组红包数据</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; timer; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> temp = <span class="keyword">this</span>.randomAlloc(amount, length, <span class="number">0</span>, amount); <span class="comment">// 传入数据为 金额，数量，最小金额，最大金额</span></span><br><span class="line">    data.push(...temp);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 打乱红包数据</span></span><br><span class="line">  <span class="keyword">if</span> (lucky.length) &#123;</span><br><span class="line">    lucky.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> random = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * (data.length - <span class="number">10</span>));</span><br><span class="line">      data.splice(random, <span class="number">0</span>, item);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.data = data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 金额生成</span></span><br><span class="line">randomAlloc(total, length, min, max) &#123;</span><br><span class="line">  <span class="comment">// 首先要判断是否符合 min 和 max 条件</span></span><br><span class="line">  <span class="keyword">if</span> (min * length &gt; total || max * length &lt; total) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">`没法满足最最少 <span class="subst">$&#123;min&#125;</span> 最大 <span class="subst">$&#123;max&#125;</span> 的条件`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> result = [];</span><br><span class="line">  <span class="keyword">let</span> restValue = total;</span><br><span class="line">  <span class="keyword">let</span> restLength = length;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; length; i++) &#123;</span><br><span class="line">    restLength--;</span><br><span class="line">    <span class="comment">// 这一次要发的数量必须保证剩下的要足最小量</span></span><br><span class="line">    <span class="comment">// 同进要保证剩下的不能大于需要的最大量</span></span><br><span class="line">    <span class="keyword">const</span> restMin = restLength * min;</span><br><span class="line">    <span class="keyword">const</span> restMax = restLength * max;</span><br><span class="line">    <span class="comment">// 可发的量</span></span><br><span class="line">    <span class="keyword">const</span> usable = restValue - restMin;</span><br><span class="line">    <span class="comment">// 最少要发的量</span></span><br><span class="line">    <span class="keyword">const</span> minValue = <span class="built_in">Math</span>.max(min, restValue - restMax);</span><br><span class="line">    <span class="comment">// 以 minValue 为最左，max 为中线来进行随机，即随机范围是 (max - minValue) * 2</span></span><br><span class="line">    <span class="comment">// 如果这个范围大于 usable - minValue，取 usable - minValue</span></span><br><span class="line">    <span class="keyword">const</span> limit = <span class="built_in">Math</span>.min(usable - minValue, (max - minValue) * <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 随机部分加上最少要发的部分就是应该发的，但是如果大于 max，最大取到 max</span></span><br><span class="line">    <span class="keyword">const</span> amount = <span class="built_in">Math</span>.min(</span><br><span class="line">      max,</span><br><span class="line">      minValue + <span class="built_in">Math</span>.floor(limit * <span class="built_in">Math</span>.random())</span><br><span class="line">    );</span><br><span class="line">    result.push(&#123; <span class="attr">amount</span>: amount &#125;);</span><br><span class="line">    restValue -= amount;</span><br><span class="line">  &#125;</span><br><span class="line">  result[length - <span class="number">1</span>] = &#123; <span class="attr">amount</span>: <span class="built_in">Math</span>.floor(restValue) &#125;;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>下落的具体代码我从Github上找了一个开源的红包下落的构造函数，然后按照公司的需求改写了一下，直接贴上来吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">luckyMoney</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.el = options.el; <span class="comment">// 容器对象</span></span><br><span class="line">  <span class="keyword">this</span>.rain = []; <span class="comment">// 红包雨数组</span></span><br><span class="line">  <span class="keyword">this</span>.speed = options.speed; <span class="comment">// 红包落下的速度</span></span><br><span class="line">  <span class="keyword">this</span>.density = options.density; <span class="comment">// 红包下落的密度</span></span><br><span class="line">  <span class="keyword">this</span>.callback = options.callback; <span class="comment">// 回调</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建红包</span></span><br><span class="line">luckyMoney.prototype.create = <span class="function"><span class="keyword">function</span>(<span class="params">id, amount</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="keyword">this</span>.el, <span class="comment">// 容器</span></span><br><span class="line">    lucky = <span class="built_in">document</span>.createElement(<span class="string">"span"</span>); <span class="comment">// 创建一个span元素</span></span><br><span class="line">  <span class="keyword">let</span> flag = <span class="literal">true</span>; <span class="comment">// 标志为true</span></span><br><span class="line">  lucky.setAttribute(<span class="string">"amount"</span>, amount); <span class="comment">// 设置红包金额</span></span><br><span class="line">  lucky.setAttribute(<span class="string">"title"</span>, (amount / <span class="number">100</span>).toFixed(<span class="number">2</span>)); <span class="comment">// 设置红包金额</span></span><br><span class="line">  lucky.className = <span class="string">"luckyMoney"</span>; <span class="comment">// 设置类名 luckyMoney</span></span><br><span class="line">  <span class="keyword">if</span> (amount &gt; <span class="number">1000</span>) lucky.setAttribute(<span class="string">"lucky"</span>, <span class="string">"lucky"</span>);</span><br><span class="line">  lucky.style.left =</span><br><span class="line">    <span class="built_in">Math</span>.random() * (el.clientWidth * <span class="number">0.5</span>) + el.clientWidth * <span class="number">0.2</span> + <span class="string">"px"</span>; <span class="comment">// 设置 left 初始位置</span></span><br><span class="line">  lucky.style.top = -el.clientHeight / <span class="number">10</span> + <span class="string">"px"</span>; <span class="comment">// 设置 top 初始位置</span></span><br><span class="line">  el.appendChild(lucky); <span class="comment">// 把虚拟节点添加到容器内</span></span><br><span class="line">  <span class="keyword">this</span>.rain.push(lucky); <span class="comment">// 把红包元素添加到红包雨数组内</span></span><br><span class="line">  <span class="keyword">this</span>.move(lucky); <span class="comment">// 开始移动红包元素</span></span><br><span class="line">  <span class="comment">// 打开红包</span></span><br><span class="line">  <span class="keyword">var</span> handler = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果flag为真 -&gt; 红包未点开过</span></span><br><span class="line">    <span class="keyword">if</span> (flag === <span class="literal">true</span>) &#123;</span><br><span class="line">      e.target.className = <span class="string">"luckyMoney opened"</span>; <span class="comment">// 添加已打开类名 opened</span></span><br><span class="line">      <span class="keyword">this</span>.callback(e); <span class="comment">// 回调</span></span><br><span class="line">      flag = <span class="literal">false</span>; <span class="comment">// 标志改为false</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span>; <span class="comment">// 跳出</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 添加触摸事件</span></span><br><span class="line">  <span class="built_in">document</span>.addEventListener(<span class="string">"touchstart"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果被点击的元素类名为 luckyMoney</span></span><br><span class="line">    <span class="keyword">if</span> (e.target.className === <span class="string">"luckyMoney"</span>) &#123;</span><br><span class="line">      handler(e); <span class="comment">// 触发红包打开事件</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.target.getAttribute(<span class="string">"amount"</span>) === <span class="string">"0"</span>) &#123;</span><br><span class="line">      e.target.className = <span class="string">"luckyMoney luckyMoneyNone"</span>; <span class="comment">// 如果红包金额为 0修改类名为 luckyMoneyNone</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 其它直接返回</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 红包开始下落</span></span><br><span class="line">luckyMoney.prototype.start = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>; <span class="comment">// 计数器</span></span><br><span class="line">  <span class="comment">// 按照红包密度时间创建红包</span></span><br><span class="line">  <span class="keyword">this</span>.timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果没有超过红包总数</span></span><br><span class="line">    <span class="keyword">if</span> (i &lt; data.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> id = data[i].id, <span class="comment">// 红包ID</span></span><br><span class="line">        amount = data[i].amount; <span class="comment">// 包红金额</span></span><br><span class="line">      <span class="keyword">this</span>.create(id, amount); <span class="comment">// 创建红包对象</span></span><br><span class="line">      i++; <span class="comment">// 计数器+1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="keyword">this</span>.density);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 红包下落停止</span></span><br><span class="line">luckyMoney.prototype.stop = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  clearInterval(<span class="keyword">this</span>.timer); <span class="comment">// 清除计时器</span></span><br><span class="line">  <span class="comment">// 清除所有红包的移动计时器</span></span><br><span class="line">  <span class="keyword">this</span>.rain.forEach(<span class="function"><span class="params">rain</span> =&gt;</span> &#123;</span><br><span class="line">    clearInterval(rain.timer);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 红包移动</span></span><br><span class="line">luckyMoney.prototype.move = <span class="function"><span class="keyword">function</span>(<span class="params">rain</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="keyword">this</span>.el; <span class="comment">// 容器</span></span><br><span class="line">  <span class="keyword">let</span> diffY = <span class="built_in">Math</span>.random() / <span class="number">2</span> + <span class="number">0.4</span>, <span class="comment">// 垂直上的轻微偏移</span></span><br><span class="line">    diffX = <span class="built_in">Math</span>.random() / <span class="number">2</span>; <span class="comment">// 水平上的轻微偏移</span></span><br><span class="line">  <span class="keyword">const</span> amount = rain.getAttribute(<span class="string">"amount"</span>);</span><br><span class="line">  <span class="comment">// 特殊红包大于10元重置为缓落</span></span><br><span class="line">  <span class="keyword">if</span> (amount &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">    diffY = <span class="number">0.4</span>;</span><br><span class="line">    diffX = <span class="built_in">Math</span>.random() / <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 红包移动按照设置的速率</span></span><br><span class="line">  rain.timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果y轴偏移吵过1.5</span></span><br><span class="line">    <span class="keyword">if</span> (diffY &gt; <span class="number">1.5</span>) &#123;</span><br><span class="line">      <span class="comment">// 设置红包雨的 left 值</span></span><br><span class="line">      rain.style.left =</span><br><span class="line">        <span class="built_in">parseInt</span>(rain.style.left) +</span><br><span class="line">        <span class="built_in">parseInt</span>((diffX * rain.clientHeight) / <span class="number">30</span>) +</span><br><span class="line">        <span class="string">"px"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 设置红包雨的 left 值</span></span><br><span class="line">      rain.style.left =</span><br><span class="line">        <span class="built_in">parseInt</span>(rain.style.left) -</span><br><span class="line">        <span class="built_in">parseInt</span>((diffX * rain.clientHeight) / <span class="number">30</span>) +</span><br><span class="line">        <span class="string">"px"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置红包雨的 top 值</span></span><br><span class="line">    rain.style.top =</span><br><span class="line">      <span class="built_in">parseInt</span>(rain.style.top) +</span><br><span class="line">      <span class="built_in">parseInt</span>((diffY * rain.clientHeight) / <span class="number">20</span>) +</span><br><span class="line">      <span class="string">"px"</span>;</span><br><span class="line">    <span class="keyword">const</span> position = &#123;</span><br><span class="line">      top: <span class="built_in">parseInt</span>(rain.style.top),</span><br><span class="line">      left: <span class="built_in">parseInt</span>(rain.style.left)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      position.top &gt; el.clientHeight ||</span><br><span class="line">      position.left &gt; el.clientWidth ||</span><br><span class="line">      position.left &lt; <span class="number">-100</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// 超出屏幕过后，清除定时器，删除红包</span></span><br><span class="line">      clearInterval(rain.timer);</span><br><span class="line">      el.removeChild(rain);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="keyword">this</span>.speed);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 时间停止时清除剩余红包</span></span><br><span class="line">luckyMoney.prototype.clear = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="keyword">this</span>.el, <span class="comment">// 容器</span></span><br><span class="line">    redItem = el.childNodes;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = redItem.length - <span class="number">1</span>; i &gt; <span class="number">-1</span>; i--) &#123;</span><br><span class="line">    el.removeChild(redItem[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> luckyMoney;</span><br></pre></td></tr></table></figure>

<p>每次点开红包之后会收集金额到 <code>tempMoney</code> 和 <code>totalMoney</code>中，并且提交到后台然后清空 <code>tempMoney</code>（这边做了1秒的节流操作），这样大银幕就能展示当前轮次的 <code>Top5</code> 用户。</p>
<p>手机端的大部分内容就是这样了，主要是下落这块比较麻烦，其它的都是一些样式的问题，稍微调试一下就行了。</p>
<h2 id="🏮大荧幕部分"><a href="#🏮大荧幕部分" class="headerlink" title="🏮大荧幕部分"></a>🏮大荧幕部分</h2><p><img src="https://yogwang.site/2019/AnnualParty-devDiay02/stage.jpg" alt="大银幕截图"></p>
<p>大银幕这块的话就容易很多了，本来是考虑用 <code>WebSocket</code> 来实时传输红包排名的，但是发现还不如轮询简单，所以还是我这边做了1秒间隔的轮询。<br>获取到数据之后跟新排名数据，界面就会实时刷新了，这边在展示用户排名时做了动画，每次用户新进和排名更替都会进行左右移动，并不只是简单的修改了展示的数据。</p>
<p>用到了<code>transform</code>的偏移量来修改展示的位置，这样就可以通过修改元素次序来打到用户排名更替补间动画了</p>
<h4 id="Stylus片段"><a href="#Stylus片段" class="headerlink" title="Stylus片段"></a>Stylus片段</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">.rank-box</span><br><span class="line">  <span class="attribute">width</span> <span class="number">90%</span></span><br><span class="line">  <span class="attribute">height</span> <span class="number">300px</span></span><br><span class="line">  <span class="attribute">max-width</span> <span class="number">1600px</span></span><br><span class="line">  <span class="attribute">display</span> flex</span><br><span class="line">  <span class="attribute">justify-content</span> space-around</span><br><span class="line">  <span class="attribute">position</span> absolute</span><br><span class="line">  <span class="attribute">left</span> <span class="number">50%</span></span><br><span class="line">  <span class="attribute">bottom</span> <span class="number">5vh</span></span><br><span class="line">  <span class="attribute">z-index</span> <span class="number">5</span></span><br><span class="line">  <span class="attribute">transform</span> translateX(-<span class="number">50%</span>)</span><br><span class="line">.lucky-box</span><br><span class="line">  <span class="attribute">width</span> <span class="number">180px</span></span><br><span class="line">  <span class="attribute">height</span> <span class="number">260px</span></span><br><span class="line">  <span class="attribute">line-height</span> <span class="number">25px</span></span><br><span class="line">  <span class="attribute">font-size</span> <span class="number">18px</span></span><br><span class="line">  <span class="attribute">background</span> url(<span class="string">'~assets/img/luckyBox.png'</span>) center no-repeat</span><br><span class="line">  <span class="attribute">background-size</span> <span class="number">100%</span> <span class="number">100%</span></span><br><span class="line">  <span class="attribute">padding</span> <span class="number">20px</span></span><br><span class="line">  <span class="attribute">border-radius</span> <span class="number">15px</span></span><br><span class="line">  <span class="attribute">border</span> <span class="number">#d5b06e</span> <span class="number">3px</span> solid</span><br><span class="line">  <span class="attribute">box-shadow</span> <span class="number">10px</span> <span class="number">10px</span> <span class="number">32px</span> rgba(black, <span class="number">0.45</span>)</span><br><span class="line">  <span class="attribute">display</span> flex</span><br><span class="line">  <span class="attribute">justify-content</span> center</span><br><span class="line">  <span class="attribute">align-items</span> center</span><br><span class="line">  <span class="attribute">flex-direction</span> column</span><br><span class="line">  <span class="attribute">position</span> absolute</span><br><span class="line">  <span class="attribute">left</span> <span class="number">50%</span></span><br><span class="line">  <span class="attribute">bottom</span> <span class="number">0</span></span><br><span class="line">  <span class="attribute">transform</span> translateX(<span class="number">800px</span>)</span><br><span class="line">  <span class="attribute">opacity</span> <span class="number">1</span></span><br><span class="line">  <span class="attribute">transition</span> all <span class="number">0.5s</span></span><br><span class="line">  <span class="attribute">box-sizing</span> border-box</span><br><span class="line">  &amp;:nth-child(<span class="number">1</span>)</span><br><span class="line">    <span class="attribute">transform</span> translateX(-<span class="number">350%</span>)</span><br><span class="line">    <span class="attribute">z-index</span> <span class="number">10</span></span><br><span class="line">  &amp;:nth-child(<span class="number">2</span>)</span><br><span class="line">    <span class="attribute">transform</span> translateX(-<span class="number">200%</span>)</span><br><span class="line">    <span class="attribute">z-index</span> <span class="number">9</span></span><br><span class="line">  &amp;:nth-child(<span class="number">3</span>)</span><br><span class="line">    <span class="attribute">transform</span> translateX(-<span class="number">50%</span>)</span><br><span class="line">    <span class="attribute">z-index</span> <span class="number">8</span></span><br><span class="line">  &amp;:nth-child(<span class="number">4</span>)</span><br><span class="line">    <span class="attribute">transform</span> translateX(<span class="number">100%</span>)</span><br><span class="line">    <span class="attribute">z-index</span> <span class="number">7</span></span><br><span class="line">  &amp;:nth-child(<span class="number">5</span>)</span><br><span class="line">    <span class="attribute">transform</span> translateX(<span class="number">250%</span>)</span><br><span class="line">    <span class="attribute">z-index</span> <span class="number">6</span></span><br><span class="line">  &amp;:nth-child(<span class="number">5</span>)~.lucky-box</span><br><span class="line">    <span class="attribute">transform</span> translateX(<span class="number">800px</span>)</span><br><span class="line">    <span class="attribute">z-index</span> <span class="number">5</span></span><br><span class="line">    <span class="attribute">opacity</span> <span class="number">0</span></span><br><span class="line">  .avatar</span><br><span class="line">    <span class="attribute">width</span> (@width / <span class="number">2</span>)</span><br><span class="line">    <span class="attribute">height</span> @width</span><br><span class="line">    <span class="attribute">border</span> <span class="number">#d5b06e</span> <span class="number">4px</span> solid</span><br><span class="line">    <span class="attribute">border-radius</span> <span class="number">50%</span></span><br><span class="line">    <span class="attribute">margin</span> <span class="number">0</span> auto <span class="number">10px</span></span><br><span class="line">    <span class="attribute">display</span> block</span><br></pre></td></tr></table></figure>

 
  </article>


    </div>
  </div>
   
<nav id="article-nav">
  
    <a href="/2019/AnnualParty-devDiay03/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">newer</strong>
      <div class="article-nav-title">
        
          年会开发日记03 - WebSocket长连接获取微信签到用户信息
        
      </div>
    </a>
  
  
    <a href="/2019/JS-navigation-detection/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">older</strong>
      <div class="article-nav-title">Javascript 滚动侦测导航</div>
    </a>
  
</nav>
 
</div>



</main>
<aside id="sidebar">
  
    
<section class="userinfo">
    <img src="/img/userimg.jpg" alt="王阳阳">
    <h2>王阳阳</h2>
    <span>久之须自见得</span>
    <p>ODIN.INC</p>
    <p>Jiaxing,China</p>
    <div>
      
      <a class='fa fa-github' href="https://github.com/yogwang" target="_blank"></a>
      
      <a class='fa fa-weibo' href="http://weibo.com/yooooooge" target="_blank"></a>
      
    </div>
</section>

  
    
  <section class="widget-wrap">
    <h3 class="widget-title">recent_posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/JS-array-fill/">ES6 中 Array 的 fill() 方法</a>
          </li>
        
          <li>
            <a href="/2020/js-slider-captcha/">简单实现滑动滑块完成验证</a>
          </li>
        
          <li>
            <a href="/2020/caddy-single-domain-vue-laravel-deployment/">Caddy单域名部署Vue与Laravel项目</a>
          </li>
        
          <li>
            <a href="/2020/intranet-and-extranet-routes/">记录单独配置内网路由和外网路由的办法</a>
          </li>
        
          <li>
            <a href="/2020/JS-closures/">谈一谈 JavaScript 中的闭包</a>
          </li>
        
      </ul>
    </div>
  </section>

  
    
  <section class="widget-wrap">
    <h3 class="widget-title">archive</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li></ul>
    </div>
  </section>


  
    
  <section class="widget-wrap">
    <h3 class="widget-title">tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ant-Design-Vue/">Ant-Design-Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apache/">Apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Axios/">Axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BetterScrol-js/">BetterScrol.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Caddy/">Caddy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Canvas/">Canvas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome/">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Coding/">Coding</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DigitalOcean/">DigitalOcean</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ESlint/">ESlint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Electron/">Electron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Handlebars/">Handlebars</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSON-Server/">JSON-Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jeecg-boot/">Jeecg-boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MockJS/">MockJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHPOK/">PHPOK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ReactJS/">ReactJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Server/">Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Three-js/">Three.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-Router/">Vue-Router</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VueJS/">VueJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/">WebSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WordPress/">WordPress</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tinyMCE/">tinyMCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习/">学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/年会开发日记/">年会开发日记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/总结/">总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/挖坑/">挖坑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/未完成/">未完成</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/问题/">问题</a></li></ul>
    </div>
  </section>


  
</aside>
    </div>
    <footer id="footer">
  <span>
    &copy;2019-2020 YogWang powered_by
    <a href="http://hexo.io/" target="_blank">Hexo</a>
  </span>
  <br />
  <span
    >licensed
    <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank"
      >CC BY-NC 4.0</a
    ></span
  >
</footer>
<div>
  <a id="gotop" class="fa fa-level-up"></a>
</div>
<script src="https://unpkg.com/jquery@3.4.1/dist/jquery.js"></script> <script src="/js/common.js"></script>

  </body>
</html>
